name: Build & Deploy NestJS Webhook to EC2 instance

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Code
        uses: actions/checkout@v3

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: ğŸ“¦ Install Dependencies
        run: npm install --legacy-peer-deps

      - name: ğŸ—ï¸ Build Project
        run: npm run build

      - name: ğŸ“ Archive Build
        run: |
          echo "ğŸ“¦ Archiving build files..."
          tar -czf app.tar.gz dist node_modules package.json package-lock.json ecosystem.config.js
          echo "âœ… Archive created: app.tar.gz"

      - name: ğŸ§  Add EC2 Host to known_hosts
        run: |
          echo "ğŸ” Setting up SSH directory..."
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "ğŸ” Testing SSH connectivity..."
          if ! ssh-keyscan -H -t rsa 3.110.243.213 2>&1 >/dev/null; then
            echo "âŒ Failed to scan host key"
            exit 1
          fi

          echo "ğŸ“ Adding host key to known_hosts..."
          ssh-keyscan -H -t rsa 3.110.243.213 >> ~/.ssh/known_hosts 2>/dev/null
          chmod 644 ~/.ssh/known_hosts

          echo "âœ… Verifying known_hosts entry..."
          if ! ssh-keygen -F 3.110.243.213 >/dev/null; then
            echo "âŒ Failed to add host to known_hosts"
            exit 1
          fi
          echo "âœ… Host successfully added to known_hosts"

      - name: ğŸ—ï¸ Prepare remote folder
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 3.110.243.213
          username: ${{ secrets.EC2_USER_NAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/dbadmin/pos-web-hook

      - name: ğŸš€ Deploy to EC2 via SCP
        uses: appleboy/scp-action@v0.1.4
        with:
          host: 3.110.243.213
          username: ${{ secrets.EC2_USER_NAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: 'app.tar.gz'
          target: '/home/dbadmin/pos-web-hook'

      - name: ğŸ”§ SSH into EC2 and Setup App
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 3.110.243.213
          username: ${{ secrets.EC2_USER_NAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ“‚ Navigating to app directory..."
            cd /home/dbadmin/pos-web-hook

            echo "ğŸ§¹ Cleaning old build files..."
            rm -rf dist node_modules

            echo "ğŸ“¦ Extracting new build..."
            tar -xzf app.tar.gz --overwrite

            echo "ğŸ—‘ï¸ Removing archive..."
            rm app.tar.gz

            echo "ğŸ”„ Managing PM2 application..."
            pm2 restart pos-web-hook
            echo "âœ…âœ…âœ…  Deployment done !"
